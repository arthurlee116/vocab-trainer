# 学习进度统计面板实现计划

## 📊 项目现状分析

### 现有架构
- **前端**: React 18 + TypeScript + Vite，使用 Tailwind CSS
- **后端**: Node.js + Express + Better-SQLite3
- **数据库**: sessions 表结构完整，包含所需字段
- **类型定义**: 已有 SessionRecord、SessionStatus 等核心类型

### Sessions 表结构
```sql
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  user_id TEXT,
  mode TEXT NOT NULL,
  difficulty TEXT NOT NULL,
  words TEXT NOT NULL,           -- JSON 数组
  super_json TEXT NOT NULL,       -- JSON 对象
  answers TEXT NOT NULL,          -- JSON 数组
  score REAL NOT NULL,
  analysis TEXT NOT NULL,         -- JSON 对象
  created_at TEXT NOT NULL,
  status TEXT DEFAULT 'in_progress',
  current_question_index INTEGER DEFAULT 0,
  updated_at TEXT
);
```

## 🎯 实现步骤

### 1. 类型定义扩展
**文件**: `server/src/types/index.ts` 和 `client/src/types/index.ts`
- 新增 `StatsResponse` 接口
- 新增 `WeeklyActivity` 接口
- 确保前后端类型一致性

### 2. 后端服务层实现
**文件**: `server/src/services/history.ts`
- 实现 `getLearningStats(userId: string)` 方法
- SQL 聚合查询优化：
  ```sql
  -- 总学习单词数（去重）
  SELECT COUNT(DISTINCT word) FROM sessions, json_each(words) WHERE status = 'completed'
  
  -- 完成的会话数
  SELECT COUNT(*) FROM sessions WHERE status = 'completed'
  
  -- 最近7天活动
  SELECT DATE(updated_at) as date, COUNT(*) as count 
  FROM sessions WHERE status = 'completed' AND updated_at >= date('now', '-7 days')
  GROUP BY DATE(updated_at)
  ```

### 3. 后端 API 路由
**文件**: `server/src/routes/history.ts`
- 新增 `GET /api/history/stats` 端点
- 集成认证中间件
- 添加参数验证和错误处理

### 4. 前端数据获取
**文件**: `client/src/lib/api.ts`
- 新增 `fetchLearningStats()` 函数
- 实现错误处理和类型安全

### 5. 前端组件开发
**主文件**: `client/src/pages/DashboardPage.tsx`
- 在页面顶部添加统计面板区域
- 集成数据获取和状态管理

**新增组件**:
- 指标卡片：3个等宽卡片展示核心指标
- CSS 柱状图：7天活动数据可视化
- 响应式布局和动画效果

### 6. 样式实现
- 使用 Tailwind CSS 实现响应式布局
- CSS 动画：数值变化平滑过渡
- 悬停效果：柱状图显示具体数值

## 🔧 技术要点

### 性能优化
- 使用 SQL 聚合查询，避免内存处理
- 参数化查询防止 SQL 注入
- 查询响应时间控制在 100ms 内

### 用户体验
- 加载状态处理
- 错误状态展示
- 平滑动画过渡
- 响应式设计适配

### 类型安全
- 严格 TypeScript 类型定义
- 前后端类型同步
- Zod 参数验证

## 📋 验证方案

### API 测试
```bash
curl -X GET http://localhost:3000/api/history/stats
```

### 前端验证
- 检查 API 响应数据结构
- 验证统计数据准确性
- 测试响应式布局
- 动画效果测试

## 📁 修改文件清单

### 后端修改
1. `server/src/types/index.ts` - 新增类型定义
2. `server/src/services/history.ts` - 统计方法实现
3. `server/src/routes/history.ts` - API 路由添加

### 前端修改
1. `client/src/types/index.ts` - 新增类型定义
2. `client/src/lib/api.ts` - API 客户端扩展
3. `client/src/pages/DashboardPage.tsx` - 主页面集成

## ⏱️ 预估时间
- 后端开发：2-3小时
- 前端开发：2-3小时
- 测试验证：1-2小时
- **总计：5-8小时**

该计划遵循项目现有架构规范，确保代码质量和可维护性。